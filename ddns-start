#!/bin/sh
# ==========================================================
# Merlin Cloudflare DDNS æ›´æ–°è„šæœ¬ï¼ˆCloudflare API v4ï¼‰
#
# è¯´æ˜     : åœ¨åç¡•è·¯ç”±å™¨ï¼ˆAsuswrt-Merlin å›ºä»¶ï¼‰ä¸­ï¼Œé€šè¿‡ è‡ªå®šä¹‰ DDNSï¼ˆCustom DDNSï¼‰åŠŸèƒ½ï¼Œå°†è·¯ç”±å™¨çš„WAN IPv4 / IPv6 åœ°å€è‡ªåŠ¨æ›´æ–°åˆ°ä½ åœ¨ Cloudflare æ³¨å†Œçš„å­åŸŸå DNS è®°å½•ä¸­ã€‚
# 1.å®‰è£…è„šæœ¬ï¼šå°†æœ¬è„šæœ¬å‘½åä¸ºddns-startï¼Œé€šè¿‡SSHä¸Šä¼ åˆ°Merlinè·¯ç”±å™¨çš„/jffs/scripts/ç›®å½•ï¼Œè¿è¡Œå‘½ä»¤chmod +x /jffs/scripts/ddns-startï¼Œèµ‹äºˆå…¶å¯æ‰§è¡Œæƒé™ã€‚
# 2.é…ç½®è·¯ç”±å™¨ DDNS è®¾ç½®ï¼šç™»å½•è·¯ç”±å™¨åå°ç®¡ç†ç•Œé¢ï¼Œå‰å¾€é«˜çº§è®¾ç½® > å¤–éƒ¨ç½‘ç»œ (WAN) > DDNSï¼Œå¯åŠ¨DDNSï¼ˆå‹¾é€‰å¯ç”¨ï¼‰ï¼ŒæœåŠ¡å™¨é€‰æ‹©Customï¼Œä¸»æœºåç§°å¡«å†™ä½ åœ¨ Cloudflare ä¸­çš„å­åŸŸåï¼ˆå»ºè®®ä¸è„šæœ¬ä¸­çš„ RECORD_NAME ä¿æŒä¸€è‡´ï¼‰ï¼Œè‹¥è¯¥å­åŸŸåæœªåœ¨ Cloudflare ä¸­åˆ›å»ºï¼Œè„šæœ¬å°†è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„ A / AAAA è®°å½•ï¼ŒHTTPS/SSL è¯ä¹¦é€‰æ‹©è‡ªåŠ¨ï¼Œç‚¹æŒ‰â€œåº”ç”¨æœ¬é¡µé¢è®¾ç½®â€ï¼Œæ­¤æ—¶è·¯ç”±å™¨å°†ç«‹å³æ‰§è¡Œ DDNS æ›´æ–°ï¼Œè°ƒç”¨æœ¬è„šæœ¬å®Œæˆ IP åœ°å€åŒæ­¥è‡³ Cloudflareã€‚
# 3.éœ€è¦ curlã€jqæ”¯æŒã€‚

# æµ‹è¯•å‹å·ï¼šè·¯ç”±å™¨ï¼šRT-AX88U Proï¼›å›ºä»¶ç‰ˆæœ¬ï¼ˆFirmwareï¼‰ï¼šAsuswrt-Merlin 3004.388.8_2ï¼›å·²å®‰è£…è½¯ä»¶ï¼šMerlin Clash2 v0.4.3
# ä½œè€…     : Nianqing
# æ—¥æœŸ     : 2025-05-31
# ç‰ˆæœ¬     : v1.0.0
# GitHub   : https://github.com/nianqingnet/merlin-cloudflare-ddns
# è®¸å¯åè®® : MIT License
# è„šæœ¬ç”Ÿæˆå‚è€ƒå¹¶ä¼˜åŒ–äº ChatGPT æä¾›çš„å»ºè®®
# ==========================================================


# ====== è®¾ç½® PATH ç¯å¢ƒå˜é‡ ======
export PATH=/opt/bin:/opt/sbin:/usr/bin:/bin:/usr/sbin:/sbin:/koolshare/bin

# ====== é…ç½®é¡¹ ======
API_TOKEN="Cloudflare API Token"      # å¿…å¡«ï¼šä½ çš„Cloudflare API Token | Your Cloudflare API Token
ZONE_ID="Cloudflare Zone ID"        # å¿…å¡«ï¼šä½ çš„ Cloudflare Zone ID | Your Cloudflare Zone ID, hex16 string
RECORD_NAME="sub.example.com"    # å¿…å¡«ï¼šä½ çš„å®Œæ•´å­åŸŸå | Full DNS record name, e.g., sub.example.com
RECORD_TTL=1                    # TTL ç§’æ•°ï¼ˆ1 è¡¨ç¤ºè‡ªåŠ¨ | TTL in seconds (1 = auto)
UPDATE_IPv6=false # æ˜¯å¦å¯ç”¨ IPv6ï¼ˆtrue/falseï¼‰| Whether to enable IPv6 (true/false)
PROXIED=false             # æ˜¯å¦ä½¿ç”¨ Cloudflare åŠ é€Ÿï¼ˆtrue/falseï¼‰| Whether to use Cloudflare acceleration (true/false)
DEBUG=true               # æ˜¯å¦å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼ˆtrue/falseï¼‰| Whether to enable debug logging (true/false)
# =======================

# å…¬å…± IP è·å–åœ°å€ï¼Œå¯é€‰å¦‚ï¼šhttps://4.ipw.cn/
IP_CHECK_URL="https://ipv4.icanhazip.com"

# === DNS ä¸´æ—¶é…ç½®æ–‡ä»¶ï¼ˆMerlin Clash2 çš„Fake-ipæ¨¡å¼ä¼šä¿®æ”¹/etc/resolv.confæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨è‡ªå®šä¹‰DNSä¸­æ·»åŠ fake-ip-filter:    - '*.cloudflare.com'å‚æ•°è§„é¿apiçš„è¿æ¥é—®é¢˜ï¼‰ ===
ORIGINAL_RESOLV="/etc/resolv.conf"
TEMP_RESOLV="/tmp/resolv.conf.ddns"

# æ›¿æ¢ resolv.conf ä½¿ç”¨æŒ‡å®š DNS
cat > "$TEMP_RESOLV" <<EOF
nameserver 223.5.5.5
nameserver 119.29.29.29
nameserver 8.8.8.8
options rotate timeout:1 attempts:2
EOF

# å¤‡ä»½åŸå§‹ /etc/resolv.conf å¹¶æ›¿æ¢ä¸ºæŒ‡å®šDNS
cp "$ORIGINAL_RESOLV" "${ORIGINAL_RESOLV}.bak"
cp "$TEMP_RESOLV" "$ORIGINAL_RESOLV"

log() {
  if [ "$DEBUG" = true ]; then
    logger "[DDNS] $1"
  fi
}


# ========= è·å–å…¬ç½‘ IPv4 =========
  IPv4=$(nvram get wan0_ipaddr)

  if [ -z "$IPv4" ] || ! echo "$IPv4" | grep -Eq '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
    log "âš ï¸ nvram è·å– IPv4 å¤±è´¥ï¼Œå°è¯• curl è·å–å…¬ç½‘ IPv4 åœ°å€"
  IPv4=$(curl -s --connect-timeout 3 "$IP_CHECK_URL" | tr -d '\r\n')
  fi

  if [ -z "$IPv4" ] || ! echo "$IPv4" | grep -Eq '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
    logger "âŒ æ— æ³•è·å–æœ‰æ•ˆå…¬ç½‘ IPv4 åœ°å€ï¼Œç»ˆæ­¢æ›´æ–°"
    mv "${ORIGINAL_RESOLV}.bak" "$ORIGINAL_RESOLV"
    exit 1
  fi

  logger "âœ… è·å–åˆ°å…¬ç½‘ IPv4ï¼š$IPv4"

# ========= è·å– IPv6ï¼ˆå¯é€‰ï¼‰ =========
if [ "$UPDATE_IPv6" = true ]; then
IPv6=$(ip -6 route get 2001:4860:4860::8888 2>/dev/null | grep -oP 'src \K[0-9a-f:]+')

# IPv6=$(ip -6 addr show scope global | \
#   grep -v -E 'fe80|fd[0-9a-f]{2}:' | \
#   sed -n 's/.*inet6 \([0-9a-f:]*\).*/\1/p' | \
#   head -n1)

if [ -z "$IPv6" ]; then
  logger "âš ï¸ æœªèƒ½é€šè¿‡è·¯ç”±è·å–å…¬ç½‘ IPv6 åœ°å€"
else
  logger "âœ… è·å–åˆ°å…¬ç½‘ IPv6 åœ°å€ï¼š$IPv6"
fi
fi


# === Cloudflare DNS æ“ä½œå‡½æ•°å®šä¹‰ ===

get_dns_record_ids() {
  local type=$1
  local response
  response=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records?type=${type}&name=${RECORD_NAME}" \
    -H "Authorization: Bearer ${API_TOKEN}" \
    -H "Content-Type: application/json")

  log "ğŸ“¥ Cloudflare è·å–è®°å½• ($type): $response"

  if ! echo "$response" | jq -e '.success == true' >/dev/null; then
    log "âŒ è·å–è®°å½•å¤±è´¥ï¼š$(echo "$response" | jq -c '.errors')"
    return 1
  fi

  echo "$response" | jq -r '.result[].id'
}

create_record() {
  local type=$1
  local ip=$2

  local response=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records" \
    -H "Authorization: Bearer ${API_TOKEN}" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"${type}\",\"name\":\"${RECORD_NAME}\",\"content\":\"${ip}\",\"ttl\":${RECORD_TTL},\"proxied\":${PROXIED}}")

  log "ğŸ“¡ Cloudflare è¿”å›: $(echo "$response" | jq -c '{success, result, errors}')"

  if echo "$response" | grep -q '"success":\s*true'; then
    log "âœ… æˆåŠŸåˆ›å»º $type è®°å½• $RECORD_NAME â†’ $ip"
    return 0
  else
    log "âŒ åˆ›å»º $type è®°å½•å¤±è´¥"
    log "ğŸ“‹ é”™è¯¯è¯¦æƒ…: $(echo "$response" | jq '.errors')"
    return 1
  fi
}

update_dns_record() {
  local record_id=$1
  local type=$2
  local ip=$3

  RESPONSE=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records/${record_id}" \
    -H "Authorization: Bearer ${API_TOKEN}" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"${type}\",\"name\":\"${RECORD_NAME}\",\"content\":\"${ip}\",\"ttl\":${RECORD_TTL},\"proxied\":${PROXIED}}")

  log "âœï¸ æ›´æ–° $type è®°å½•å“åº”ï¼š$RESPONSE"
  echo "$RESPONSE" | grep '"success":\ *true' >/dev/null
  if [ $? -eq 0 ]; then
    logger "âœ… æˆåŠŸæ›´æ–° $type è®°å½• $RECORD_NAME -> $ip"
  else
    logger "âŒ æ›´æ–° $type è®°å½•å¤±è´¥: $RESPONSE"
    RESULT=false
  fi
}


# ========= ä¸»æ‰§è¡Œé€»è¾‘ =========
RESULT=true

# === æ›´æ–° IPv4 DNS è®°å½• ===
A_RECORD_IDS=$(get_dns_record_ids A)

if [ -z "$A_RECORD_IDS" ]; then
  logger "ğŸ” æ²¡æœ‰æ‰¾åˆ° A è®°å½•ï¼Œå°è¯•åˆ›å»ºâ€¦â€¦"

  if create_record A "$IPv4"; then
    logger "âœ… æˆåŠŸåˆ›å»º A è®°å½•ï¼Œå°è¯•è·å– $RECORD_NAME çš„ Record ID å¹¶æ›´æ–°ã€‚"
    A_RECORD_IDS=$(get_dns_record_ids A)
    if [ -n "$A_RECORD_IDS" ]; then
      update_dns_record "$A_RECORD_IDS" A "$IPv4" || RESULT=false
    else
      logger "âŒ åˆ›å»ºæˆåŠŸä½†ä»æœªæ‰¾åˆ°è®°å½• IDã€‚"
      RESULT=false
    fi
  else
    logger "âŒ åˆ›å»º $RECORD_NAMEçš„ A è®°å½•å¤±è´¥ã€‚"
    RESULT=false
  fi
else
  log "ğŸŒ è·å–åˆ°çš„ A è®°å½• ID: $A_RECORD_IDS"
  update_dns_record "$A_RECORD_IDS" A "$IPv4" || RESULT=false
fi


# === æ›´æ–° IPv6 DNS è®°å½• ===
if [ "$UPDATE_IPv6" = true ] && [ -n "$IPv6" ]; then
  AAAA_ID=$(get_dns_record_ids AAAA)
  if [ -z "$AAAA_ID" ]; then
    logger "ğŸ” æœªæ‰¾åˆ° AAAA è®°å½•ï¼Œå°è¯•åˆ›å»ºâ€¦â€¦"
    if create_record AAAA "$IPv6"; then
      logger "âœ… æˆåŠŸåˆ›å»º AAAA è®°å½•ï¼Œå°è¯•è·å– $RECORD_NAME çš„ Record ID å¹¶æ›´æ–°ã€‚"
      AAAA_ID=$(get_dns_record_ids AAAA)
      if [ -n "$AAAA_ID" ]; then
        update_dns_record "$AAAA_ID" AAAA "$IPv6" || RESULT=false
      else
        logger "âŒ åˆ›å»ºæˆåŠŸä½†æ— æ³•è·å–æ–°çš„ AAAA è®°å½• IDã€‚"
        RESULT=false
      fi
    else
      logger "âŒ åˆ›å»º $RECORD_NAMEçš„ AAAA è®°å½•å¤±è´¥ã€‚"
      RESULT=false
    fi
  else
    update_dns_record "$AAAA_ID" AAAA "$IPv6" || RESULT=false
  fi
fi


# === è¿˜åŸåŸå§‹  /etc/resolv.conf DNS é…ç½® ===
mv "${ORIGINAL_RESOLV}.bak" "$ORIGINAL_RESOLV"

# === é€šçŸ¥  Merlin ç³»ç»Ÿ DDNS çŠ¶æ€ ===
if [ "$RESULT" = true ]; then
  /sbin/ddns_custom_updated 1
  echo "âœ… DDNS æ›´æ–°å®Œæˆï¼ŒçŠ¶æ€ï¼šæˆåŠŸï¼"
else
  /sbin/ddns_custom_updated 0
  echo "âŒ DDNS æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ã€‚"
fi